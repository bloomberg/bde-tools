#!/bin/ksh

typeset USAGE
USAGE="Usage: $0 [-l|-o|-h] lib obj [obj...]
  lib is full uorname (e.g. apputil or gtk/gtkapp)
  obj is the name of an object file that is built in lib
    (note that for a Fortran object, this must be the name of the separated
    file that contains an individual subroutine, not the container file
    that holds all of the original source subroutines at once.)
  -l to only get library level analysis
  -o to only get object level analysis  (default is both )
  -h (or --help) to get this usage information
"

typeset libanal
typeset objanal

if [[ "$1" = "-h" ]] || [[ "$1" = "--help" ]]
then
    echo "$USAGE"
    return 0
elif [ $1 = "-l" ]
then
    libanal=1
    shift
elif [ $1 = "-o" ]
then
    objanal=1
    shift
else
    libanal=1
    objanal=1
fi

typeset lib=$1
shift

if cd /bbs/$lib
then
    :	# cd succeeded
else
    echo cannot cd to "$lib" in /bbs - aborting
    echo "$USAGE"
    return 1
fi

typeset objlist=
for obj in "$@"
do
    obj=${obj%.o}
    if [ -f tmpmake/$obj.o ]
    then
	objlist="$objlist tmpmake/$obj.o"
    elif [ -f $obj.o ]
    then
	objlist="$objlist $obj.o"
    elif [ -f $obj ]
    then
	objlist="$objlist $obj"
    else
	echo "no object found for $obj"
    fi
done

if [ -z "$objlist" ]
then
    echo "no object files found to analyse - aborting"
    echo "$USAGE"
    return 1
fi

for obj in "$objlist"
do
    symfind --callers $obj > /tmp/jmm.c.$$
    symfind --deps $obj > /tmp/jmm.d.$$
    if [ -n "$libanal" ]
    then
	echo "==== ($lib) $obj caller libraries"
	libnames /tmp/jmm.c.$$ | tee /tmp/jmm.C.$$
	echo
	echo "==== ($lib) $obj dep libraries"
	libnames /tmp/jmm.d.$$ | tee /tmp/jmm.D.$$
	echo
	echo "==== ($lib) $obj CYCLIC libraries ****"
	comm -12 /tmp/jmm.C.$$ /tmp/jmm.D.$$
	echo
    fi
    if [ -n "$objanal" ]
    then
	echo "==== ($lib) $obj caller objects"
	cat /tmp/jmm.c.$$
	echo
	echo "==== ($lib) $obj dep objects"
	cat /tmp/jmm.d.$$
	echo
    fi
    echo
done
rm /tmp/jmm.?.$$
