#!/bbs/opt/bin/perl

my $cycle = "$1" || "1";

my @full_hier = `level_report.pl`;
chomp @full_hier;

my @ball = grep { /\(cycle $cycle\)/ } @full_hier;
s/^\s*// for @ball;
s/\s*\(cycle .*// for @ball;

my( %map_strong ) = map { $_        => $_ } @ball;
# my( %map_weak   ) = map { "weak:$_" => $_ } @ball;
my %map_weak;
$map_weak{ "weak:$_" } = $_ for @ball;

my %strong_link_from;
my %weak_link_from;
my %strong_link_to;
my %weak_link_to;

for my $from (@ball) {
    my @lines = `catDeps $from 2>/dev/null`;
    chomp @lines;
    for (@lines) {
	if( $map_strong{$_} ) {
	    push( @{$strong_link_from{$from}}, $_ );
	    push( @{$strong_link_to{$_}}, $from );
	} elsif( $map_weak{$_}	) {
	    push( @{$weak_link_from{$from}}, $map_weak{$_} );
	    push( @{$weak_link_to{$map_weak{$_}}}, $from );
	}
    }
}

sub print_set {
    my( $desc, $list ) = @_;
    if( @$list ) {
	print "    $desc ", scalar(@$list),"\n";
	print "                ", $_, "\n" for @$list;
    }
}

for my $from (sort @ball) {
    print "$from:\n";
    print_set( "strong dep ", $strong_link_to{$from} );
    print_set( "weak dep   ", $weak_link_to{$from} );
    print_set( "strong call", $strong_link_from{$from} );
    print_set( "weak call  ", $weak_link_from{$from} );
}
