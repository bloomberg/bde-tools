#!/usr/bin/ksh
# baellog_cleanup.sh - clean up bael log files
# command line arguments to this script will be forwarded to baellog_cleanup.pl

export PATH="$PATH:/bb/bin"

svc_delete_after=31
xbig_delete_after=5
bass_compress_after=2
bass_delete_after=14
intrl_bass_compress_after=8
intrl_bass_delete_after=35

# Flip the cleanup log file after it grows larger than 8MB.
LOGFILE=/bb/data/baellog_cleanup.log
LOGFILE_SIZE=`ls -l $LOGFILE | awk '{print $5}'`
if [[ $(($LOGFILE_SIZE)) -gt 8388608 ]]; then
    mv $LOGFILE $LOGFILE.previous
fi

# Remove log files generated by BAS service offlines.
baellog_audit.pl -d /bb/bin -d /int/bin -d /fax/bin $svc_delete_after >> /bb/data/baellog_cleanup.log 2>&1

# Remove monrdsvc log files (non-standard deployment)
baellog_cleanup.pl $@ -v -f -d /bb/bin/app_depl/rtsmon/monrdsvc/log -e mnrdsv $svc_delete_after >>/bb/data/baellog_cleanup.log

# Remove log files generated by the BIGs.
baellog_cleanup.pl $@ -v -f -d /bb/data -e ".*\.bael\.log\..*" $xbig_delete_after >> /bb/data/baellog_cleanup.log

# Force bass to rotate its log.
if [[ -x /bb/bin/send ]]; then
    /bb/bin/send bass rotatelog
else
    for ctrl in /tmp/basctrl.bass $TMPDIR/basctrl.bass /bb/bin/basctrl.bass
    do
        if [[ -p "$ctrl" ]]; then
            /bin/echo rotatelog > "$ctrl" &
            /bin/sleep 2
            kill %% 2>/dev/null
        fi
    done
fi

# Compress log files generated by the service router.
baellog_cleanup.pl $@ -v -f -d /bb/data -d /bb/data20 -d /bb/logs -e ".*bass\.log.\.*" -c $bass_compress_after >> /bb/data/baellog_cleanup.log 2>&1

# Remove log files generated by the service router.
baellog_cleanup.pl $@ -v -f -d /bb/data -d /bb/data20 -e ".*bass\.log.\.*" $bass_delete_after >> /bb/data/baellog_cleanup.log 2>&1

# Compress log files generated by the internal systems service router.
baellog_cleanup.pl $@ -v -f -d /int/data -d /int2/data -d /int3/data -d /int4/data -d /int5/data -e ".*bass\.log.\.*" -c $intrl_bass_compress_after >> /bb/data/baellog_cleanup.log 2>&1

# Remove log files generated by the internal systems service router.
baellog_cleanup.pl $@ -v -f -d /int/data -d /int2/data -d /int3/data -d /int4/data -d /int5/data -e ".*bass\.log.\.*" $intrl_bass_delete_after >> /bb/data/baellog_cleanup.log 2>&1
